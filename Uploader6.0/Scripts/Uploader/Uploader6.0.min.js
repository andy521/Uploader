(function(a){var j={url:"",isImg:true,targetExt:".png",tempFile:"/content/tempfile/",error:function(m){alert(m)}};var k=function(o,p){var m=this;var n={url:j.url,text:"选择文件",type:"single",handleType:"0",subfolder:"",more:false,debug:true,maxWidth:1960,maxHeight:1000,minWidth:300,minHeight:300,tempFile:j.tempFile,auto:true,isImg:true,fileExts:"jpg;png;gif;bmp;jpeg",timeout:30000,onStart:function(){},onSuccess:function(q){},onError:function(q){j.error(q)},onClick:function(){},maxSize:1024*1024*1024,getMaxSize:function(){return e(this.maxSize)},coverParams:{}};this.elem=o;this.opts=a.extend({},n,p)};k.prototype={init:function(){var o=this;var n=this.opts;var m=this.elem;if(n.type=="dialog"){o.initDialog()}else{o.initBtn()}},initBtn:function(){var o=this;var n=this.opts;var m=this.elem;var r=d("uploader_text");r.text(n.text);m.append(r);var p=d("uploader_file");var q=a('<input  type="file" name="file"  tabindex="10000"/>');if(n.more){q.prop("multiple","multiple")}p.append(q);p.append('<input type="hidden" name="target" class="target" />');m.append(p);if(m.next().hasClass("uploader_panel")==false){m.after(d("uploader_panel"))}if(n.type=="imgdouble"){o.initImgDouble()}else{o.bindBtn()}},bindBtn:function(){var o=this;var m=this.elem;var n=this.opts;var p=m.find("input[type=file]")[0];p.onchange=function(){if(this.files.length<=0){n.onError("没有获取到上传文件");return}var r=this.files;if(n.more){var v=[];for(var s=0;s<r.length;s++){var q=r[s];var u=new h(q,o,false);v.push(u)}var s=0;var t=0;w();var x=setInterval(function(){if(t-s>2){return}w()},1000);function w(){var y=v[s];y.start();y.onSendSuccess=function(){t++};s++;if(s>=r.length){clearInterval(x)}}}else{var q=this.files[0];var u=new h(q,o,o.opts.auto)}}},initDialog:function(){var o=this;var n=this.opts;var m=this.elem;m.text(n.text);m.click(function(){o.cover=new c(o)})},initImgDouble:function(){var o=this;var m=this.elem;var n=this.opts;m.append('<canvas id="canvasImg" style="display:none;"/>');var p=m.find("input[type=file]");p.change(function(){var r=this.files;if(n.more){var t=-1;var s=0;var u=setInterval(function(){if(s>t){var v=r[s];if(b(v.name,n)){o.bindImgDouble(v,function(){s++})}}if(s==r.length-1){clearInterval(u)}t=s},100)}else{var q=r[0];if(b(q.name,n)==false){return false}o.bindImgDouble(q)}})},bindImgDouble:function(r,s){var o=this;var n=this.opts;var m=this.elem;var p=document.getElementById("canvasImg");var q=p.getContext("2d");var t=new FileReader();t.onload=function(){var v=t.result;var u=new Image();u.onload=function(){var y=u.width;var x=u.height;if(y>n.maxWidth){x=x*(n.maxWidth/y);y=n.maxWidth}if(x>n.maxHeight){y=y*(n.maxHeight/x);x=n.maxHeight}u.width=p.width=y;u.height=p.height=x;q.clearRect(0,0,y,x);q.drawImage(u,0,0,y,x);var w=p.toDataURL("image/jpeg");n.targetExt=".jpg";if(n.handleType!=0){n.subfolder2="/big"}l(o,w,"image/jpeg",function(z){var A={};A.big=z;if(y>n.minWidth){x=x*(n.minWidth/y);y=n.minWidth}if(x>n.minHeight){y=y*(n.minHeight/x);x=n.minHeight}u.width=p.width=y;u.height=p.height=x;q.clearRect(0,0,y,x);q.drawImage(u,0,0,y,x);w=p.toDataURL("image/jpeg");if(n.handleType!=0){n.subfolder2="/small"}l(o,w,"image/jpeg",function(B){A.small=B;o.imgDoubleSuccess(A);if(s){s(B)}})})};u.src=v};t.readAsDataURL(r)},imgDoubleSuccess:function(o){var n=this;var m=this.opts;if(m.onSuccess){m.onSuccess(o)}}};function c(r){var n=this;n.uploader=r;var p={title:"上传图片",itemWidth:380,itemHeight:380,targetWidth:200,targetHeight:100,onYes:function(){},onCancel:function(){},onClose:function(){return true}};this.opts=a.extend({},p,n.uploader.opts.coverParams);var m=this.opts;n.initWidth=0;n.initHeight=0;n.scale=1;n.spanBackLeft=0;n.spanBackTop=0;var q=a(d("contentElem"));m.width=m.itemWidth+20+m.targetWidth+30+20;m.height=m.itemHeight+30+35+20;var o=a.cover({width:m.width,height:m.height,borderRadius:0,clickDestroy:false,html:q});this.elem=q;this.cover=o;this.init()}c.prototype={init:function(){var o=this;var n=this.opts;var m=this.elem;o.initTop();var p=d("uploader_middle");m.append(p);o.initLeftItem();o.initRightItem();p.append(d("clear"));o.initBottom();o.bind()},bind:function(){var o=this;var m=this.elem;var n=this.opts;var q=document.getElementById("canvasSource");var s=q.getContext("2d");var t=m.find(".imgItem");var r=t.find("#canvasUp");var p=t.find(".canvasBack");var v=false;var x=0,y=0;r.mousedown(function(z){v=true;x=z.pageX-r.offset().left;y=z.pageY-r.offset().top;return false});p.mouseup(function(z){v=false;u=false}).mousemove(function(B){if(v){var E=B.pageX-t.offset().left-x;var F=B.pageY-t.offset().top-y;o.setCanvasUpSite(E,F)}if(u){var z=B.clientX;var A=B.clientY;var C=z-w;var D=A-oldY;o.spanBackLeft+=C;o.spanBackTop+=D;s.translate(C,D);o.reShow();w=z;oldY=A}}).mouseleave(function(){v=false;u=false});addMouseWheel(p[0],function(z){var B=z.delta>0?0.1:-0.1;var C=o.initWidth*o.scale;var A=o.initHeight*o.scale;if(B<0){if(C*A<=(o.initWidth*o.initHeight/2)){return}}else{if(C*A>=(o.img.width*o.img.height*1.5)){return}}o.scale+=B;o.reShow();return false});var u=false;var w=oldY=0;p.mousedown(function(z){u=true;w=z.clientX;oldY=z.clientY});o.bindSquare();o.bindDrag()},bindSquare:function(){var o=this;var m=this.elem;var n=this.opts;var v=m.find(".imgItem");var q=v.find("#canvasUp");var p=q.parent();var w=-1,B=0,C=0,A=0,x=0,y=0,z=0;var r=v.find(".divSquare");r.mousedown(function(E){D(1,E);return false});var s=v.find(".divSquare_lb");s.mousedown(function(E){D(2,E);return false});var t=v.find(".divSquare_lt");t.mousedown(function(E){D(3,E);return false});var u=v.find(".divSquare_rt");u.mousedown(function(E){D(4,E);return false});p.mousemove(function(E){var H=20;var I=E.pageX;var J=E.pageY;var K=rHeight=rLeft=rTop=0;if(w==1){var L=I-B;var M=L*(n.targetHeight/n.targetWidth);K=L+A;rHeight=M+x;rLeft=y;rTop=z}else{if(w==2){var M=J-C;var L=-M*(n.targetWidth/n.targetHeight);K=A-L;rHeight=x+M;rLeft=y+L;rTop=z}else{if(w==3){var L=I-B;var M=L*(n.targetHeight/n.targetWidth);K=A-L;rHeight=x-M;rLeft=y+L;rTop=z+M}else{if(w==4){var M=J-C;var L=-M*(n.targetWidth/n.targetHeight);K=A+L;rHeight=x-M;rLeft=y;rTop=z+M}else{return}}}}var G=p.width()-q.position().left;var F=p.height()-q.position().top;K=K>G?G:K;rHeight=rHeight>F?F:rHeight;rLeft=rLeft<0?0:rLeft;rTop=rTop<0?0:rTop;K=K<n.targetWidth?n.targetWidth:K;rHeight=rHeight<n.targetHeight?n.targetHeight:rHeight;q.css({left:rLeft,top:rTop});q.attr("width",K).attr("height",rHeight);o.showTarget();o.setSquareSite();return false}).mouseup(function(E){w=-1;return false}).mouseleave(function(){w=-1;return false});function D(F,E){w=F;B=E.pageX;C=E.pageY;y=q.position().left;z=q.position().top;A=q.width();x=q.height()}},bindDrag:function(){var n=this;var m=this.elem.get(0);var p=this.elem.parents(".coverInner");document.ondragover=function(){return false};document.ondrop=function(){return false};m.ondragenter=function(q){return false};m.ondragover=function(){p.addClass("coverInner-hot");return false};m.ondrop=function(q){var s=q.dataTransfer.files;if(s.length>0){var r=s[0];if(o(r)==false){return false}var t=new FileReader();t.onload=function(){n.showImg(t.result)};t.readAsDataURL(r)}p.removeClass("coverInner-hot");return false};function o(q){if(!/image\/\w+/.test(q.type)){error(q.name+"-----不是图片");return false}return true}},initTop:function(){var o=this;var n=this.opts;var m=this.elem;var r=d("top");var q=d("title");q.text(n.title);r.append(q);var p=d("closeBtn");p.append('<a href="javascript:void(0)" title="关闭">×</a>');p.click(function(){var s=n.onClose();if(s){o.destroy()}});r.append(p);m.append(r)},initLeftItem:function(){var o=this;var n=this.opts;var m=this.elem;var x=m.find(".uploader_middle");var w=d("leftItem");x.append(w);w.css({width:n.itemWidth,height:n.itemHeight});var z=d("uploadItem");var y=d("upBtnDiv");var p=d("btnDesc");p.text("将图片拖入框中即可读取");y.append(p);y.append(d("uploader"));z.append(y);var t=d("extention");var u="";if(o.uploader.opts.fileExts!="*"){u="*仅支持"+o.uploader.opts.fileExts+","}t.text(u+"不超过"+e(o.uploader.opts.maxSize));y.append(t);w.append(z);var v=d("imgItem");v.css({width:n.itemWidth,height:n.itemHeight,position:"relative"});var q=a('<canvas id="canvasSource" width="'+n.itemWidth+'" height="'+n.itemHeight+'"></canvas>');q.css({position:"absolute"});v.append(q);var r=d("canvasBack");r.css({width:n.itemWidth,height:n.itemHeight});var s=a('<canvas id="canvasUp" width="'+n.targetWidth+'" height="'+n.targetHeight+'"></canvas>');r.append(s);r.append(d("divSquare"));r.append(d("divSquare_lb"));r.append(d("divSquare_lt"));r.append(d("divSquare_rt"));v.append(r);v.hide();w.append(v);o.initBtn()},initRightItem:function(){var o=this;var n=this.opts;var m=this.elem;var q=m.find(".uploader_middle");var s=d("rightItem");q.append(s);var r=d("previewDiv");var u=d("targetOneItem");var t=d("targetOne");var p=a('<canvas id="canvasTarget"><canvas/>');p.attr("width",n.targetWidth).attr("height",n.targetHeight);t.append(p);var v=d("targetText");v.text(""+n.targetWidth+"px * "+n.targetHeight+"px");u.append(t).append(v);r.append(u);s.append(r)},initBottom:function(){var o=this;var n=this.opts;var m=this.elem;var p=d("uploader_btnDiv");m.append(p);var r=a('<span class="uploader_yes"/>');r.text("确定");r.click(function(){var s=a(this);if(s.text()=="正在提交..."){return}o.submit();s.text("正在提交...")});var q=a('<span  class="uploader_cancel"/>');q.text("取消");q.click(function(){n.onCancel(o);o.destroy()});p.append(r).append(q)},initBtn:function(){var o=this;var n=this.opts;var m=this.elem;var p=m.find(".uploader");p.addClass("uploader-default");p.append(d("uploader_text").text("选择图片"));var q=d("uploader_file");var r=a('<form enctype="multipart/form-data"/>');r.append('<input  type="file" name="file" tabindex="10000"  />');q.append(r);q.append('<input type="hidden" name="target" class="target" />');p.append(q);addMouseWheel(m[0],function(s){try{s.preventDefault()}catch(s){return false}});o.bindRead()},bindRead:function(){var o=this;var n=this.opts;var m=this.elem;var p=m.find("input[type=file]");p.change(function(){var s=a(this).val();if(b(s,o.uploader.opts)==false){return false}var q=this.files[0];var r=new FileReader();r.onload=function(){o.showImg(r.result)};r.readAsDataURL(q)})},setCanvasUpSite:function(p,s){var m=this;var o=a("#canvasUp");var n=o.parent();var q=n.width()-o.width()-1;var r=n.height()-o.height()-1;p=p>q?q:p;s=s>r?r:s;p=p<0?0:p;s=s<0?0:s;p=Math.round(p)+1;s=Math.round(s)+1;o.css({left:p,top:s});m.setSquareSite();m.showTarget()},setSquareSite:function(){var m=a("#canvasUp");a(".divSquare").css({left:m.position().left+m.width()-2,top:m.position().top+m.height()-2});a(".divSquare_lb").css({left:m.position().left-2,top:m.position().top+m.height()-2});a(".divSquare_lt").css({left:m.position().left-2,top:m.position().top-2});a(".divSquare_rt").css({left:m.position().left+m.width()-2,top:m.position().top-2})},showImg:function(p){var o=this;var n=this.opts;var m=this.elem;var s=m.find(".leftItem");var t=m.find(".uploadItem");var r=m.find(".imgItem");var q=new Image();q.onload=function(){t.hide();r.show();var u=m.find(".uploader_btnDiv");if(u.find(".uploader").length==0){var v=m.find(".uploader");u.prepend(v.clone(true));v.remove()}o.imgReadedInit()};q.src=p;o.img=q;o.initWidth=o.initHeight=0;o.scale=1},imgReadedInit:function(){var o=this;var n=this.opts;var m=this.elem;var s=o.img;var t=m.find(".imgItem");var p=document.getElementById("canvasSource");var r=p.getContext("2d");var y=0,v=0,w=0,x=0;if(s.width<=n.targetWidth||s.height<=n.targetHeight){y=s.width;v=s.height;x=(t.height()-v)/2+1;w=(t.width()-y)/2+1}else{if(s.width>s.height){y=t.width();var u=y/s.width;v=s.height*u;x=(t.height()-v)/2+1}else{v=t.height();var u=v/s.height;y=s.width*u;w=(t.width()-y)/2+1}}r.clearRect(0,0,p.width,p.height);w=Math.round(w);x=Math.round(x);y=Math.round(y);v=Math.round(v);if(o.initWidth==0){o.initWidth=y;o.initHeight=v}o.reShow();r.drawImage(s,w,x,y,v);setTimeout(function(){o.showTarget()},100);var q=a("#canvasUp");o.setCanvasUpSite((t.width()-q.width())/2,(t.height()-q.height())/2)},reShow:function(){var m=this;var o=document.getElementById("canvasSource");var q=o.getContext("2d");var n=m.elem.find(".canvasBack");var r=n.width();var p=n.height();var v=m.initWidth*m.scale;var s=m.initHeight*m.scale;var t=Math.round((r-v)/2);var u=Math.round((p-s)/2);q.clearRect(-m.spanBackLeft,-m.spanBackTop,r,p);q.drawImage(m.img,t,u,v,s);m.showTarget()},showTarget:function(){var o=a("#canvasUp");var u=o.position().left;var v=o.position().top;var w=o.width();var t=o.height();var m=document.getElementById("canvasSource");var p=m.getContext("2d");var s=p.getImageData(u,v,w,t);var r=o[0].getContext("2d");r.putImageData(s,0,0);var n=document.getElementById("canvasTarget");var q=n.getContext("2d");q.clearRect(0,0,n.width,n.height);q.rect(0,0,n.width,n.height);q.fillStyle="white";q.fill();q.drawImage(o[0],0,0,n.width,n.height)},submit:function(){var n=this;var m=this.uploader.opts;var o=document.getElementById("canvasTarget").toDataURL("image/jpeg",1);n.total=o.length;m.targetExt=".jpg";l(n.uploader,o,"image/jpg",function(p){if(m.onSuccess){m.onSuccess(p)}n.destroy();n.elem.find(".uploader_yes").text("确定")},function(){console.info("上传失败")})},destroy:function(){this.cover.destroy()}};function l(u,q,s,w,v){var m=u.opts;var p=q.split(",")[1];p=window.atob(p);var n=new Uint8Array(p.length);for(var r=0;r<p.length;r++){n[r]=p.charCodeAt(r)}var o=new Blob([n],{type:s});var x=new i(u,undefined,undefined);x.onopen=function(){var y={oldName:"前台处理图片"+m.targetExt,size:o.size,subfolder:m.subfolder+(m.subfolder2||""),handleType:m.handleType,other:"",};x.send(JSON.stringify(y));x.send(o)};var t=0;x.onmessage=function(y){var z=JSON.parse(y);t+=z.curLength||0;if(t>=o.size){x.close();w(z)}}}function h(o,p,n){var m=this;this.uploader=p;this.file=o;this.step=1024*256;this.loaded=0;this.readed=0;this.enableRead=n||false;this.startTime=new Date();this.total=o.size;this.debug=p.opts.debug;this.sending=false;if(this.check()){this.init();if(m.enableRead){m.start()}}}h.prototype={check:function(){var n=this;var m=this.uploader.opts;if(this.total>m.maxSize){m.onError("文件大小不能超过："+m.getMaxSize());return false}return b(n.file.name,m);return true},init:function(){var m=this;var o=this.uploader.elem.next();var n=d("uploader_item");this.elem=n;n.append('<div class="title"><span class="file-icon"></span> <span class="file-name">'+this.file.name+"</span></div>");n.append('<div class="uploader-progress"><progress></progress></div>');var q=d("status");q.append('<div class="left"><span class="btn-proc">暂停</span></div>');var p=d("right");p.append('<span id="loaded">0</span>/<span class="total">'+e(this.total)+"</span>");p.append("&emsp;");p.append('<span class="time-proc">0</span>');q.append(p);q.append('<div class="clear"></div>');n.append(q);n.append('<span class="close">&times;</span>');o.append(n);m.showStatus();n.find(".btn-proc").click(function(){var r=a(this);if(r.text()=="暂停"){r.text("开始");m.stop()}else{r.text("暂停");m.containue()}});n.find(".close").click(function(){if(window.confirm("关闭将会放弃上传！")){m.close();n.slideUp("normal",function(){n.remove()})}})},start:function(){var m=this;m.enableRead=true;var n=new i(m.uploader,this);this.socket=n;n.onopen=function(){m.bindReader()};n.onmessage=function(o){var p=JSON.parse(o);m.result=p;if(p.newName.length>0&&p.status==1){m.newName=p.newName||"";m.loaded+=p.curLength||0;m.showStatus();if(m.loaded>=m.total){m.sendSuccess();if(m.debug){console.log("总上传："+m.loaded+",用时："+(new Date().getTime()-m.startTime.getTime())/1000)}}}else{console.error("上传出错：");console.error(p)}}},showStatus:function(){var m=this;var n=m.elem;if(m.enableRead==false){return}var p=n.find("progress")[0];p.value=m.loaded;p.max=m.total;var o=n.find("#loaded");o.text(e(m.loaded));var q=n.find(".time-proc");var r=(new Date().getTime()-m.startTime.getTime())/1000;q.text(f(r))},bindReader:function(){var m=this;var n=this.reader=new FileReader();n.onload=function(o){m.readed+=o.loaded;m.sendData();if(m.readed<m.total){if(m.socket.ws.bufferedAmount>1204*1024*2){var p=setInterval(function(){if(m.socket.ws.bufferedAmount<=1204*1024){console.log("------>进入等待结束");clearInterval(p);m.readBlob()}},10)}else{m.readBlob()}}else{if(m.debug){console.log("总读取："+m.readed+",用时："+(new Date().getTime()-m.startTime.getTime())/1000)}}};m.readBlob()},sendData:function(){var n=this;var m=this.uploader.opts;var q=this.reader;var r=this.socket;var o=q.result;if(n.sending==false){var p={oldName:n.file.name,newName:n.newName,size:n.total,subfolder:m.subfolder,handleType:m.handleType,other:"",};r.send(JSON.stringify(p));n.sending=true}r.send(o)},onSendSuccess:function(){},sendSuccess:function(){var n=this;n.elem.find(".btn-proc").off("click").html('<span style="color:red;">上传成功</span>');setTimeout(function(){n.elem.slideUp("fast",function(){n.elem.remove()}).fadeOut("fast")},1500);n.close();var m=n.uploader.opts;if(m.onSuccess){m.onSuccess(n.result)}n.onSendSuccess()},readBlob:function(){var m=this;if(m.enableRead==false){return}var n=this.file.slice(this.readed,this.readed+this.step);this.reader.readAsArrayBuffer(n)},stop:function(){var m=this;if(m.debug){console.info("中止，loaded:"+m.loaded)}m.enableRead=false;m.reader.abort()},containue:function(){var m=this;if(m.debug){console.info("继续,loaded:"+m.loaded)}m.enableRead=true;m.readBlob()},close:function(){var m=this;m.stop();m.socket.close()}};function i(r,q,p){var n=this;this.uploader=r;this.reader=q;var m=this.uploader.opts;this.onSuccess=p;this.debug=m.debug;var s=m.url;if(s==undefined||s.length<=0){alert("socket链接地址不能为空");return}try{this.url=s;this.ws=new WebSocket(s)}catch(o){if(n.debug){console.error(o)}console.error("创建socket链接失败，当前地址："+s)}n.bind()}i.prototype={bind:function(){var m=this;var n=m.reader;var o=m.ws;o.onopen=function(){if(m.debug){console.log("connected成功")}m.onopen();if(m.onSuccess){m.onSuccess()}};o.onmessage=function(q){var p=q.data;m.onmessage(p)};o.onclose=function(p){if(n){n.stop()}if(m.debug){console.log("链接中断")}};o.onerror=function(p){if(n){n.stop()}if(m.debug){console.log("链接发生异常")}console.error(p)}},onopen:function(){},onmessage:function(m){},close:function(){var m=this;var n=m.ws;n.close()},send:function(n){var m=this;var o=m.ws;if(o.readyState==WebSocket.OPEN){o.send(n)}else{if(m.debug){console.info("当前链接还不是打开状态:"+o.readyState);console.error(o)}}}};function b(t,r){var m=r;if(g()){return true}var n=m.fileExts.toLowerCase().split(";");var s="文件格式不正确，仅支持："+n.join(",");if(t.length<=0){return false}if(m.fileExts=="*"){return true}var o=t.substr(t.lastIndexOf(".")+1).toLowerCase();if(o.length<=0){j.error(s);return false}for(var p=0;p<n.length;p++){var q=n[p];if(q==o){return true}}j.error(s);return false}function g(){var m=navigator.userAgent.toLowerCase();if(m.match(/MicroMessenger/i)=="micromessenger"){return true}else{return false}}function e(m){if(m>=1073741824){return(m/1073741824).toFixed(1)+"G"}if(m>=1048576){return(m/1048576).toFixed(1)+"Mb"}return(m/1024).toFixed(1)+"Kb"}function f(m){if(m>60){return Math.floor(m/60)+"m "+Math.round(m%60)+"s"}return Math.round(m)+"s"}function d(m){var n=a("<div />");n.addClass(m);return n}a.fn.uploader=function(m){var n=new k(this,m);n.init();return n}})(jQuery);(function(a){a.addMouseWheel=function(b,c){if(document.mozHidden!==undefined){b.addEventListener("DOMMouseScroll",function(d){d.delta=-(d.detail||0)/3;c(d)})}else{if(a.addEventListener){b.addEventListener("mousewheel",function(d){d.delta=d.wheelDelta/120;c(d)})}else{if(a.attachEvent){b.attachEvent("onmousewheel",function(d){d.delta=d.wheelDelta/120;return c(d)})}}}}})(window);